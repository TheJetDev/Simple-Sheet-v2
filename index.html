<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Sheet</title> 
    
    <link rel="icon" type="image/png" href="favicon-96x96.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
        .calculator-container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        .top-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .lang-switch { display: flex; gap: 3px; flex-wrap: wrap; }
        .lang-button { background: #e9ecef; border: 1px solid #ced4da; padding: 5px 6px; cursor: pointer; border-radius: 5px; font-size: 0.75em; min-width: 35px; }
        .lang-button.active { background-color: #007bff; color: white; font-weight: bold; }
        .master-name-group { flex-grow: 1; display: flex; align-items: center; border: 2px solid #007bff; border-radius: 5px; padding: 5px 10px; background-color: #f0f8ff; min-width: 200px; }
        .master-name-group label { font-weight: bold; color: #007bff; margin-right: 10px; white-space: nowrap; }
        .master-name-input { flex-grow: 1; padding: 5px; border: none; font-size: 1.0em; background-color: transparent; outline: none; }
        
        .utility-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; flex-wrap: wrap; }
        .util-btn { border: none; background: #6c757d; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 5px; }
        .util-btn:hover { background: #5a6268; }

        .mode-toggle { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; }
        .mode-button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .mode-button.active { background-color: #007bff; color: white; }
        .preset-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; padding: 10px; background-color: #eee; border-radius: 5px; flex-wrap: wrap; }
        .master-row { padding: 20px; margin-bottom: 30px; border: 3px solid #dc3545; border-radius: 8px; background-color: #ffeaea; display: flex; align-items: center; justify-content: space-between; }
        .master-label-text { font-weight: bold; margin-right: 15px; white-space: nowrap; }
        .master-input { flex-grow: 1; padding: 12px; border: 2px solid #dc3545; border-radius: 5px; font-size: 1.4em; text-align: right; }
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; flex-wrap: wrap; }
        .text-label-input { flex: 2; padding: 10px; border: 1px solid #aaa; border-radius: 5px; margin-right: 10px; min-width: 150px; }
        .base-mode-toggle { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #6c757d; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.1em; margin-right: 10px; background: #fff; transition: all 0.2s; }
        .base-mode-toggle.chain { background: #6c757d; border-color: #6c757d; color: #fff; }
        .operator-group { display: flex; flex-direction: column; align-items: center; margin: 0 10px; }
        .operator-control { font-size: 1.1em; font-weight: bold; color: #fff; background-color: #6c757d; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; border-radius: 3px; cursor: pointer; }
        .operator-display { font-size: 1.4em; font-weight: bold; color: #333; width: 30px; text-align: center; margin: 3px 0; }
        .multiplier-input { flex: 1; padding: 10px; border: 2px solid #007bff; border-radius: 5px; font-size: 1.1em; text-align: right; max-width: 80px; }
        .percent-toggle { font-size: 1.2em; font-weight: bold; color: #ccc; background-color: transparent; border: 1px solid #ccc; border-radius: 4px; margin: 0 5px; width: 35px; height: 35px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .percent-toggle.active { color: white; background-color: #dc3545; border-color: #dc3545; }
        .result-group { display: flex; align-items: center; flex: 2; justify-content: flex-end; padding-left: 10px; border-left: 1px solid #ddd; margin-left: 10px; }
        .result-text { font-size: 1.5em; font-weight: bold; color: #007bff; text-align: right; flex-grow: 1; }
        .running-total-group { flex: 2; margin-left: 20px; padding: 10px; border-left: 2px solid #6c757d; background-color: #e9ecef; border-radius: 5px; display: flex; flex-direction: column; align-items: flex-end; }
        .total-text { font-size: 1.4em; font-weight: bold; color: #28a745; }
        #saveMessage { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000; }
        .copy-btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2em; margin-left: 8px; padding: 2px; }
    </style>
</head>
<body onload="init()">
    <div class="calculator-container">
        <div class="top-controls">
            <div class="master-name-group">
                 <label id="masterLabelName">Name:</label>
                 <input type="text" id="masterLabel" class="master-name-input" oninput="saveSettings()">
            </div>
            <div class="lang-switch">
                <button class="lang-button" id="lang-en" onclick="setLanguage('en')">EN</button>
                <button class="lang-button" id="lang-ja" onclick="setLanguage('ja')">JP</button>
                <button class="lang-button" id="lang-zh" onclick="setLanguage('zh')">CN</button>
                <button class="lang-button" id="lang-ko" onclick="setLanguage('ko')">KR</button>
                <button class="lang-button" id="lang-es" onclick="setLanguage('es')">ES</button>
                <button class="lang-button" id="lang-fr" onclick="setLanguage('fr')">FR</button>
                <button class="lang-button" id="lang-pt" onclick="setLanguage('pt')">PT</button>
            </div>
        </div>

        <h2 id="title">Simple Sheet</h2>

        <div class="utility-bar">
            <button class="util-btn" onclick="clearNumbers()">üßπ <span id="btn-clear">Clear</span></button>
            <button class="util-btn" onclick="exportData()">üì§ <span id="btn-export">Export</span></button>
            <button class="util-btn" onclick="importData()">üì• <span id="btn-import">Import</span></button>
            <button class="util-btn" style="background:#dc3545;" onclick="fullReset()">üîÑ <span id="btn-reset">Reset All</span></button>
        </div>

        <div id="quickCalcLabel" style="font-weight: bold; margin-bottom: 5px; color: #666;">Quick Calculator</div>
        <div style="background: #eee; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <input type="number" id="q-v1" style="width: 80px; padding: 5px;" oninput="runQuick()">
            <select id="q-op" onchange="runQuick()"><option>+</option><option>-</option><option>√ó</option><option>√∑</option></select>
            <input type="number" id="q-v2" style="width: 80px; padding: 5px;" oninput="runQuick()">
            <span>=</span>
            <span id="q-res" style="font-weight: bold; font-size: 1.2em;">0</span>
            <button class="copy-btn-icon" onclick="copyIdText('q-res')">üìã</button>
        </div>

        <div class="mode-toggle">
            <button id="smartSheetBtn" class="mode-button" onclick="switchMode('smartSheet')">Simple</button>
            <button id="customSimpleBtn" class="mode-button" onclick="switchMode('customSimple')">Custom</button>
        </div>

        <div class="preset-controls">
            <select id="presetSelector" onchange="loadPreset()"></select>
            <button onclick="savePreset()" id="savePresetBtn">Save</button>
            <button onclick="deletePreset()" id="deletePresetBtn">Delete</button>
        </div>

        <div id="smart-sheet-mode">
            <div class="master-row">
                <label id="masterLabelStart" class="master-label-text">Base Value</label>
                <input type="number" id="masterInput" class="master-input" value="1000" oninput="updateDisplay()">
            </div>
            <div id="rows-container-smart"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="mode-button" style="background-color: #28a745; color: white;" onclick="addRowSmart()">+ Add Row</button>
                <button class="mode-button" style="background-color: #007bff; color: white;" onclick="copyPage('smart')">Copy All</button>
            </div>
        </div>

        <div id="custom-simple-mode" style="display: none;">
            <div class="master-row">
                <label id="masterLabelStartSimple" class="master-label-text">Base Value</label>
                <input type="number" id="masterInputSimple" class="master-input" value="1000" oninput="updateDisplay()">
            </div>
            <div id="rows-container-simple"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="mode-button" style="background-color: #28a745; color: white;" onclick="addRowSimple()">+ Add Row</button>
                <button class="mode-button" style="background-color: #007bff; color: white;" onclick="copyPage('custom')">Copy All</button>
            </div>
            <div style="margin-top: 30px; padding: 20px; border: 3px solid #28a745; border-radius: 8px; background-color: #e6ffed; text-align: center;">
                <div id="finalTotalLabel" style="font-weight: bold;">Final Total</div>
                <div id="finalResultTextCustom" style="font-size: 2.5em; font-weight: bold; color: #28a745;">0</div>
            </div>
        </div>

        <div id="saveMessage">Saved</div>
    </div>

    <script>
        let currentLanguage = 'en';
        const languageMap = {
            en: { title: 'Simple Sheet', masterLabelName: 'Name:', masterLabelStart: 'Base Value', savePreset: 'Save', deletePreset: 'Delete', finalTotal: 'Final Total', runningTotal: 'Total', copyMsg: 'Copied', quick: 'Quick Calculator', simple: 'Simple', custom: 'Custom', btnClear: 'Clear', btnExport: 'Export', btnImport: 'Import', btnReset: 'Reset All', confirmClear: 'Clear all numbers?', confirmReset: 'Erase ALL data?', promptImport: 'Paste data:' },
            ja: { title: '„Ç∑„É≥„Éó„É´„Ç∑„Éº„Éà', masterLabelName: 'Ë®àÁÆóÂêç:', masterLabelStart: 'ÂÖÉ„ÅÆÊï∞Â≠ó', savePreset: '‰øùÂ≠ò', deletePreset: 'ÂâäÈô§', finalTotal: 'ÊúÄÁµÇÂêàË®à', runningTotal: 'ÂêàË®à', copyMsg: '„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', quick: 'ÂçòÁ¥îË®àÁÆóÂô®', simple: '„Ç∑„É≥„Éó„É´', custom: '„Ç´„Çπ„Çø„É†', btnClear: 'Êï∞ÂÄ§„ÇØ„É™„Ç¢', btnExport: '„Éá„Éº„ÇøÂá∫Âäõ', btnImport: '„Éá„Éº„ÇøË™≠Ëæº', btnReset: 'ÂÖ®„Å¶ÂàùÊúüÂåñ', confirmClear: 'Êï∞ÂÄ§„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü', confirmReset: 'ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', promptImport: '„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºö' },
            zh: { title: 'ÁÆÄÂçïËÆ°ÁÆóË°®', masterLabelName: 'ÂêçÁß∞:', masterLabelStart: 'ÂéüÂßãÊï∞ÂÄº', savePreset: '‰øùÂ≠ò', deletePreset: 'ÂâäÈô§', finalTotal: 'ÊúÄÁªàÂêàË®à', runningTotal: 'ÂêàËÆ°', copyMsg: 'Â∑≤Â§çÂà∂', quick: 'ÁÆÄÊòìËÆ°ÁÆóÂô®', simple: 'ÁÆÄÂçï', custom: 'Ëá™ÂÆöÁæ©', btnClear: 'Ê∏ÖÈô§Êï∞Â≠ó', btnExport: 'ÂØºÂá∫Êï∞ÊçÆ', btnImport: 'ÂØºÂÖ•Êï∞ÊçÆ', btnReset: 'ÂÖ®ÈÉ®ÈáçÁΩÆ', confirmClear: 'Á°ÆËÆ§Ê∏ÖÈô§ÊâÄÊúâÊï∞Â≠óÂêóÔºü', confirmReset: 'Á°ÆËÆ§Âà†Èô§ÊâÄÊúâÊï∞ÊçÆÂíåÈ¢ÑËÆæÂêóÔºü', promptImport: 'Á≤òË¥¥Êï∞ÊçÆÔºö' },
            ko: { title: 'Ïã¨Ìîå ÏãúÌä∏', masterLabelName: 'Ïù¥Î¶Ñ:', masterLabelStart: 'Í∏∞Ï§Ä Ïà´Ïûê', savePreset: 'Ï†ÄÏû•', deletePreset: 'ÏÇ≠Ï†ú', finalTotal: 'ÏµúÏ¢Ö Ìï©Í≥Ñ', runningTotal: 'Ìï©Í≥Ñ', copyMsg: 'Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§', quick: 'Í∞ÑÌé∏ Í≥ÑÏÇ∞Í∏∞', simple: 'Ïã¨Ìîå', custom: 'Ïª§Ïä§ÌÖÄ', btnClear: 'Ïà´Ïûê ÏßÄÏö∞Í∏∞', btnExport: 'Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞', btnImport: 'Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞', btnReset: 'Ï¥àÍ∏∞Ìôî', confirmClear: 'Î™®Îì† Ïà´ÏûêÎ•º ÏßÄÏö∞ÏãúÍ≤†ÏäµÎãàÍπå?', confirmReset: 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?', promptImport: 'Îç∞Ïù¥ÌÑ∞Î•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî:' },
            es: { title: 'Hoja Simple', masterLabelName: 'Nombre:', masterLabelStart: 'Base', savePreset: 'Guardar', deletePreset: 'Borrar', finalTotal: 'Total Final', runningTotal: 'Total', copyMsg: 'Copiado', quick: 'Calculadora', simple: 'Simple', custom: 'Personalizado', btnClear: 'Limpiar', btnExport: 'Exportar', btnImport: 'Importar', btnReset: 'Reiniciar Todo', confirmClear: '¬øBorrar todos los n√∫meros?', confirmReset: '¬øEliminar TODOS los datos?', promptImport: 'Pegar datos:' },
            fr: { title: 'Feuille Simple', masterLabelName: 'Nom:', masterLabelStart: 'Valeur de Base', savePreset: 'Sauver', deletePreset: 'Supprimer', finalTotal: 'Total Final', runningTotal: 'Total', copyMsg: 'Copi√©', quick: 'Calculatrice', simple: 'Simple', custom: 'Personnalis√©', btnClear: 'Effacer', btnExport: 'Exporter', btnImport: 'Importer', btnReset: 'Tout r√©initialiser', confirmClear: 'Effacer tous les chiffres?', confirmReset: 'Supprimer TOUTES les donn√©es?', promptImport: 'Coller les donn√©es:' },
            pt: { title: 'Folha Simples', masterLabelName: 'Nome:', masterLabelStart: 'Valor Base', savePreset: 'Salvar', deletePreset: 'Excluir', finalTotal: 'Total Final', runningTotal: 'Total', copyMsg: 'Copiado', quick: 'Calculadora', simple: 'Simples', custom: 'Personalizado', btnClear: 'Limpar', btnExport: 'Exportar', btnImport: 'Importar', btnReset: 'Redefinir Tudo', confirmClear: 'Limpar todos os n√∫meros?', confirmReset: 'Excluir TODOS os dados?', promptImport: 'Colar dados:' }
        };

        function setLanguage(lang) {
            currentLanguage = lang; const dict = languageMap[lang];
            document.querySelectorAll('.lang-button').forEach(b => b.classList.toggle('active', b.id === 'lang-'+lang));
            document.getElementById('title').textContent = dict.title;
            document.getElementById('masterLabelName').textContent = dict.masterLabelName;
            document.getElementById('masterLabelStart').textContent = dict.masterLabelStart;
            document.getElementById('masterLabelStartSimple').textContent = dict.masterLabelStart;
            document.getElementById('savePresetBtn').textContent = dict.savePreset;
            document.getElementById('deletePresetBtn').textContent = dict.deletePreset;
            document.getElementById('finalTotalLabel').textContent = dict.finalTotal;
            document.getElementById('quickCalcLabel').textContent = dict.quick;
            document.getElementById('smartSheetBtn').textContent = dict.simple;
            document.getElementById('customSimpleBtn').textContent = dict.custom;
            document.getElementById('btn-clear').textContent = dict.btnClear;
            document.getElementById('btn-export').textContent = dict.btnExport;
            document.getElementById('btn-import').textContent = dict.btnImport;
            document.getElementById('btn-reset').textContent = dict.btnReset;
            updateDisplay();
        }

        function clearNumbers() {
            if(!confirm(languageMap[currentLanguage].confirmClear)) return;
            document.getElementById('masterInput').value = 0;
            document.getElementById('masterInputSimple').value = 0;
            document.querySelectorAll('.multiplier-input').forEach(i => i.value = 0);
            updateDisplay();
        }

        function exportData() {
            const data = {
                settings: JSON.parse(localStorage.getItem('simpleSheetSettings') || '{}'),
                presets: JSON.parse(localStorage.getItem('simpleSheetPresets') || '{}')
            };
            const str = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
            navigator.clipboard.writeText(str);
            showMsg(languageMap[currentLanguage].copyMsg);
        }

        function importData() {
            const str = prompt(languageMap[currentLanguage].promptImport || "Paste data:");
            if(!str) return;
            try {
                const data = JSON.parse(decodeURIComponent(escape(atob(str))));
                if(data.settings) localStorage.setItem('simpleSheetSettings', JSON.stringify(data.settings));
                if(data.presets) localStorage.setItem('simpleSheetPresets', JSON.stringify(data.presets));
                location.reload();
            } catch(e) { alert("Error"); }
        }

        function fullReset() {
            if(!confirm(languageMap[currentLanguage].confirmReset)) return;
            localStorage.clear();
            location.reload();
        }

        let rowCounterSmart = 0, rowCounterSimple = 0;

        function updateDisplay() {
            const masterVal = parseFloat(document.getElementById('masterInput').value)||0;
            document.querySelectorAll('#rows-container-smart .row').forEach(r => {
                const id = r.getAttribute('data-id'), op=document.getElementById('smart-op-'+id).textContent, mult=parseFloat(r.querySelector('.multiplier-input').value)||0, pct=r.querySelector('.percent-toggle').classList.contains('active');
                let mod=pct?masterVal*(mult/100):mult, res=0;
                if(op==='+') res=masterVal+mod; else if(op==='-') res=masterVal-mod; else if(op==='√ó') res=pct?masterVal*(mult/100):masterVal*mult; else if(op==='√∑') res=mult!==0?(pct?masterVal/(mult/100):masterVal/mult):0;
                document.getElementById('smart-res-'+id).textContent = res.toLocaleString();
            });

            const masterValSimple = parseFloat(document.getElementById('masterInputSimple').value)||0;
            let chain = masterValSimple;
            document.querySelectorAll('#rows-container-simple .row').forEach(r => {
                const id = r.getAttribute('data-id'), op=document.getElementById('simple-op-'+id).textContent, mult=parseFloat(r.querySelector('.multiplier-input').value)||0, pct=r.querySelector('.percent-toggle').classList.contains('active');
                const isChain = document.getElementById('simple-base-'+id).classList.contains('chain');
                const currentBase = isChain ? chain : masterValSimple;
                let mod=pct?currentBase*(mult/100):mult, res=0;
                if(op==='+') res=currentBase+mod; else if(op==='-') res=currentBase-mod; else if(op==='√ó') res=pct?currentBase*(mult/100):currentBase*mult; else if(op==='√∑') res=mult!==0?(pct?currentBase/(mult/100):currentBase/mult):0;
                document.getElementById('simple-res-'+id).textContent = (res-currentBase >= 0 ? "+" : "") + (res-currentBase).toLocaleString(); 
                document.getElementById('simple-run-'+id).textContent = res.toLocaleString(); chain=res;
            });
            document.getElementById('finalResultTextCustom').textContent = chain.toLocaleString();
            saveSettings();
        }

        function switchMode(mode) {
            document.getElementById('smart-sheet-mode').style.display = (mode === 'smartSheet') ? 'block' : 'none';
            document.getElementById('custom-simple-mode').style.display = (mode === 'customSimple') ? 'block' : 'none';
            document.getElementById('smartSheetBtn').classList.toggle('active', mode === 'smartSheet');
            document.getElementById('customSimpleBtn').classList.toggle('active', mode === 'customSimple');
            localStorage.setItem('currentMode', mode);
            updateDisplay();
        }

        function addRowSmart(s = null) {
            rowCounterSmart++; const id = rowCounterSmart;
            const row = document.createElement('div'); row.className = 'row'; row.id = `smart-row-${id}`; row.setAttribute('data-id', id);
            row.innerHTML = `<input type="text" class="text-label-input" value="${s?s.label:''}" oninput="saveSettings()">
                <div class="operator-group"><div class="operator-control" onclick="changeOp('${id}','smart',1)">+</div><div class="operator-display" id="smart-op-${id}">${s?s.operator:'+'}</div><div class="operator-control" onclick="changeOp('${id}','smart',-1)">-</div></div>
                <input type="number" class="multiplier-input" value="${s?s.multiplier:'0'}" oninput="updateDisplay()">
                <div class="percent-toggle ${s&&s.isPercentActive?'active':''}" onclick="togglePct('${id}','smart')">%</div>
                <div class="result-group"><div class="result-text" id="smart-res-${id}">0</div><button class="copy-btn-icon" onclick="copyRowValue('${id}','smart')">üìã</button><button style="margin-left:5px; border:none; background:none; cursor:pointer;" onclick="removeRow('${id}','smart')">üóëÔ∏è</button></div>`;
            document.getElementById('rows-container-smart').appendChild(row); updateDisplay();
        }

        function addRowSimple(s = null) {
            rowCounterSimple++; const id = rowCounterSimple;
            const row = document.createElement('div'); row.className = 'row'; row.id = `simple-row-${id}`; row.setAttribute('data-id', id);
            const isChain = s ? s.baseMode === 'chain' : true;
            row.innerHTML = `<input type="text" class="text-label-input" value="${s?s.label:''}" oninput="saveSettings()">
                <div id="simple-base-${id}" class="base-mode-toggle ${isChain?'chain':''}" onclick="toggleBaseMode('${id}')">${isChain?'üîó':'üè†'}</div>
                <div class="operator-group"><div class="operator-control" onclick="changeOp('${id}','simple',1)">+</div><div class="operator-display" id="simple-op-${id}">${s?s.operator:'+'}</div><div class="operator-control" onclick="changeOp('${id}','simple',-1)">-</div></div>
                <input type="number" class="multiplier-input" value="${s?s.multiplier:'0'}" oninput="updateDisplay()">
                <div class="percent-toggle ${s&&s.isPercentActive?'active':''}" onclick="togglePct('${id}','simple')">%</div>
                <div class="result-group"><div class="result-text" id="simple-res-${id}" style="font-size:1.5em; font-weight:bold; color:#007bff;">0</div><button style="margin-left:5px; border:none; background:none; cursor:pointer;" onclick="removeRow('${id}','simple')">üóëÔ∏è</button></div>
                <div class="running-total-group"><div style="font-size:0.7em;color:#666;">Total</div><div style="display:flex; align-items:center;"><div class="total-text" id="simple-run-${id}">0</div><button class="copy-btn-icon" onclick="copyRowValue('${id}','simple')">üìã</button></div></div>`;
            document.getElementById('rows-container-simple').appendChild(row); updateDisplay();
        }

        function toggleBaseMode(id) {
            const el = document.getElementById('simple-base-'+id);
            if(el.classList.contains('chain')) { el.classList.remove('chain'); el.textContent = 'üè†'; } 
            else { el.classList.add('chain'); el.textContent = 'üîó'; }
            updateDisplay();
        }

        function changeOp(id,m,d) { const ops=['+','-','√ó','√∑']; const el=document.getElementById(m+'-op-'+id); el.textContent = ops[(ops.indexOf(el.textContent)+d+4)%4]; updateDisplay(); }
        function togglePct(id,m) { document.querySelector(`#${m}-row-${id} .percent-toggle`).classList.toggle('active'); updateDisplay(); }
        function removeRow(id,m) { document.getElementById(m+'-row-'+id).remove(); updateDisplay(); }
        function copyIdText(id) { navigator.clipboard.writeText(document.getElementById(id).textContent); showMsg(languageMap[currentLanguage].copyMsg); }
        function copyRowValue(id, mode) { const targetId = (mode === 'simple') ? 'simple-run-' + id : 'smart-res-' + id; navigator.clipboard.writeText(document.getElementById(targetId).textContent); showMsg(languageMap[currentLanguage].copyMsg); }
        
        function copyPage(mode) {
            const name = document.getElementById('masterLabel').value || 'Sheet'; const dict = languageMap[currentLanguage]; let text = `„Äê ${name} „Äë\n`;
            if(mode === 'smart') {
                const base = document.getElementById('masterInput').value; text += `${dict.masterLabelStart}: ${base}\n---\n`;
                document.querySelectorAll('#rows-container-smart .row').forEach(r => { const id = r.getAttribute('data-id'); text += `${r.querySelector('.text-label-input').value || '-'}: ${base} ${document.getElementById('smart-op-'+id).textContent} ${r.querySelector('.multiplier-input').value}${r.querySelector('.percent-toggle').classList.contains('active')?'%':''} = ${document.getElementById('smart-res-'+id).textContent}\n`; });
            } else {
                const base = document.getElementById('masterInputSimple').value; text += `${dict.masterLabelStart}: ${base}\n---\n`;
                document.querySelectorAll('#rows-container-simple .row').forEach(r => { const id = r.getAttribute('data-id'); const isChain = document.getElementById('simple-base-'+id).classList.contains('chain'); text += `${r.querySelector('.text-label-input').value || '-'}: ${isChain?'üîó':'üè†'} ${document.getElementById('simple-op-'+id).textContent} ${r.querySelector('.multiplier-input').value}${r.querySelector('.percent-toggle').classList.contains('active')?'%':''} ‚Üí ${dict.runningTotal}: ${document.getElementById('simple-run-'+id).textContent}\n`; });
                text += `---\n${dict.finalTotal}: ${document.getElementById('finalResultTextCustom').textContent}`;
            }
            navigator.clipboard.writeText(text); showMsg(dict.copyMsg);
        }

        function runQuick() {
            const v1 = parseFloat(document.getElementById('q-v1').value) || 0, v2 = parseFloat(document.getElementById('q-v2').value) || 0, op = document.getElementById('q-op').value;
            let res = 0; if(op==='+') res=v1+v2; else if(op==='-') res=v1-v2; else if(op==='√ó') res=v1*v2; else if(op==='√∑') res=v2!==0?v1/v2:0;
            document.getElementById('q-res').textContent = res.toLocaleString();
        }

        function saveSettings() {
            const s = {
                masterLabel: document.getElementById('masterLabel').value, masterInput: document.getElementById('masterInput').value, masterInputSimple: document.getElementById('masterInputSimple').value,
                smartRows: Array.from(document.querySelectorAll('#rows-container-smart .row')).map(r => { const id = r.getAttribute('data-id'); return { label: r.querySelector('.text-label-input').value, multiplier: r.querySelector('.multiplier-input').value, operator: document.getElementById('smart-op-'+id).textContent, isPercentActive: r.querySelector('.percent-toggle').classList.contains('active') } }),
                simpleRows: Array.from(document.querySelectorAll('#rows-container-simple .row')).map(r => { const id = r.getAttribute('data-id'); return { label: r.querySelector('.text-label-input').value, multiplier: r.querySelector('.multiplier-input').value, operator: document.getElementById('simple-op-'+id).textContent, isPercentActive: r.querySelector('.percent-toggle').classList.contains('active'), baseMode: document.getElementById('simple-base-'+id).classList.contains('chain')?'chain':'master' } })
            };
            localStorage.setItem('simpleSheetSettings', JSON.stringify(s));
        }

        function init() {
            document.getElementById('rows-container-smart').innerHTML = ""; document.getElementById('rows-container-simple').innerHTML = "";
            const saved = localStorage.getItem('simpleSheetSettings');
            if(saved) {
                const s = JSON.parse(saved); document.getElementById('masterLabel').value = s.masterLabel||'';
                document.getElementById('masterInput').value = s.masterInput||1000; document.getElementById('masterInputSimple').value = s.masterInputSimple||1000;
                if(s.smartRows && s.smartRows.length) s.smartRows.forEach(r => addRowSmart(r)); else addRowSmart();
                if(s.simpleRows && s.simpleRows.length) s.simpleRows.forEach(r => addRowSimple(r)); else addRowSimple();
            } else { addRowSmart(); addRowSimple(); }
            setLanguage('ja'); refreshPresetList();
            switchMode(localStorage.getItem('currentMode')||'smartSheet');
        }

        function savePreset() {
            const name = document.getElementById('masterLabel').value; if(!name) return;
            let p = JSON.parse(localStorage.getItem('simpleSheetPresets')||'{}'); p[name] = JSON.parse(localStorage.getItem('simpleSheetSettings'));
            localStorage.setItem('simpleSheetPresets', JSON.stringify(p)); refreshPresetList(); showMsg("Saved");
        }
        function loadPreset() {
            const name = document.getElementById('presetSelector').value; if(!name) return;
            const p = JSON.parse(localStorage.getItem('simpleSheetPresets')||'{}'); localStorage.setItem('simpleSheetSettings', JSON.stringify(p[name])); location.reload();
        }
        function deletePreset() {
            const name = document.getElementById('presetSelector').value; if(!name) return;
            let p = JSON.parse(localStorage.getItem('simpleSheetPresets')||'{}'); delete p[name];
            localStorage.setItem('simpleSheetPresets', JSON.stringify(p)); refreshPresetList();
        }
        function refreshPresetList() {
            const sel = document.getElementById('presetSelector'); const p = JSON.parse(localStorage.getItem('simpleSheetPresets')||'{}');
            sel.innerHTML = '<option value="">-- Load --</option>'; for(let k in p) { const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); }
        }
        function showMsg(t) { const m = document.getElementById('saveMessage'); m.textContent = t; m.style.opacity = 1; setTimeout(() => m.style.opacity = 0, 2000); }
// „Çµ„Éº„Éì„Çπ„ÉØ„Éº„Ç´„Éº„ÅÆÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered!', reg))
                .catch(err => console.log('SW reg error:', err));
            });
        }
    </script>
</body>
</html>